<ng-container *ngIf="!thyTreeService.isCustomTemplate; else customTemplate;">
    <span class="thy-tree-node-item" [class.active]="node.selected" (click)="clickNode($event)">
       <span *ngIf="thyDraggable" class="node-draggable" [class.node-draggable-cover]="isShowExpand(node) && !node.children?.length">
           <i class="wtf wtf wtf-move"></i>
       </span>
        <span *ngIf="isShowExpand(node)" class="node-expand" (click)="expandNode($event)">
            <i class="wtf fs-16" *ngIf="node.children && node.children.length > 0" [ngClass]="{'wtf-expand': !node.expanded,'wtf-collapse': node.expanded}"></i>
        </span>
        <span *ngIf="node.icon" class="node-icon">
            <i [ngClass]="node.icon" [ngStyle]="node.iconStyle"></i>
        </span>
        <ng-container *ngIf="!node.edited">
            <span class="node-title">{{node.title}}</span>
            <span class="node-actions" *ngIf="node.key">
                <a *ngIf="isEditable(node)" thyButtonIcon="wtf-edit-o" thySize="sm" href="javascript:;" (click)="editNode($event)"></a>
                <a *ngIf="isDeletable(node)" thyButtonIcon="wtf-trash-o" thySize="sm" href="javascript:;" (click)="deleteNode($event)"></a>
            </span>
        </ng-container>
        <span *ngIf="node.edited" class="node-edit">
            <input #title thyInput thySize="sm" thyAutofocus thyStopPropagation (thyEnter)="updateNode($event,title.value)" (blur)="updateNode($event,title.value)">
        </span>
    </span>
    <div class="thy-node-children" *ngIf="node.expanded || !isShowExpand(node)" [sortablejs]="node.children"
        [sortablejsOptions]="root.treeNodesSortableOptions" [attr.node-key]="node.key">
        <thy-tree-node *ngFor="let node of node.children;trackBy:root.trackByFn;let i=index;" 
            [node]="node"
            [templateRef]="templateRef"
            [flexibleTemplateRef]="flexibleTemplateRef"
            [thyChildrenPropName]="thyChildrenPropName"
            [thyLevel]="thyLevel"
            [thyDraggable]="thyDraggable"
            [thyEditable]="thyEditable"
            [thyDeletable]="thyDeletable"
            [thyShowExpand]="thyShowExpand"
            [thyMultiple]="thyMultiple"
            (thyOnClick)="thyOnClick.emit($event)"
            (thyOnEdit)="thyOnEdit.emit($event)"
            (thyOnDelete)="thyOnDelete.emit($event)">
        </thy-tree-node>
    </div>
</ng-container>

<ng-template #customTemplate>
    <ng-container *ngIf="templateRef">
        <ng-template [ngTemplateOutlet]="templateRef" [ngTemplateOutletContext]="createNodeContext(node)"></ng-template>
        <thy-tree *ngIf="node[thyChildrenPropName] && node[thyChildrenPropName].length > 0" [thyTemplate]="templateRef"
            [thyNodes]="node[thyChildrenPropName]" [thyLevel]="thyLevel + 1"></thy-tree>
    </ng-container>
    <ng-container *ngIf="flexibleTemplateRef">
        <ng-template [ngTemplateOutlet]="flexibleTemplateRef" [ngTemplateOutletContext]="createNodeContext(node)"></ng-template>
    </ng-container>
</ng-template>